<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Leads Campaign Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background-color: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background-color: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-loading {
            background-color: #ffc107;
        }

        .status-success {
            background-color: #28a745;
        }

        .status-error {
            background-color: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .leads-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-container {
            position: relative;
            overflow: hidden;
        }

        .table-wrapper {
            overflow-x: auto;
            overflow-y: auto;
            max-height: 600px;
            scroll-behavior: smooth;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .pagination-btn {
            background-color: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: #5a67d8;
        }

        .pagination-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .pagination-info {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .leads-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leads-table th {
            background-color: #f8f9fa;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
            height: 50px;
            max-height: 50px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .leads-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            height: 60px;
            max-height: 60px;
        }

        .leads-table tr {
            height: 60px;
            max-height: 60px;
        }

        .leads-table tr:hover {
            background-color: #f8f9fa;
        }

        .lead-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-new {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .status-contacted {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .status-qualified {
            background-color: #e8f5e8;
            color: #388e3c;
        }

        .status-closed {
            background-color: #fce4ec;
            color: #c2185b;
        }

        .loading {
            text-align: center;
            padding: 4rem;
            font-size: 1.1rem;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 4rem;
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            margin: 2rem 0;
        }

        .empty-state {
            text-align: center;
            padding: 4rem;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .leads-table th,
            .leads-table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.875rem;
            }

            .stats {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Debt Leads Campaign Management</h1>
            <p>Manage and track your debt collection leads effectively</p>
        </div>

        <div class="stats" id="statsContainer"></div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search leads by name, email, phone, or debt amount...">
            </div>
            <button class="btn btn-primary" id="refreshBtn">Refresh Data</button>
            <div class="status-indicator" id="statusIndicator">
                <span class="status-dot status-loading"></span>
                <span id="statusText">Loading...</span>
            </div>
        </div>

        <div class="leads-container">
            <div id="leadsContent">
                <div class="loading">
                    <p>Loading debt leads...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://n8n.srv884802.hstgr.cloud/webhook/nd_load_debt_leads';
        const DASHBOARD_API_URL = '/api/dashboard-data';
        
        let allLeads = [];
        let filteredLeads = [];
        let dashboardData = {};
        let currentSort = { column: null, direction: 'desc' };

        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const refreshBtn = document.getElementById('refreshBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const leadsContent = document.getElementById('leadsContent');
        const statsContainer = document.getElementById('statsContainer');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            fetchLeads();
            fetchDashboardData();
            setupEventListeners();
        });

        function setupEventListeners() {
            searchInput.addEventListener('input', handleSearch);
            refreshBtn.addEventListener('click', () => {
                fetchLeads();
                fetchDashboardData();
            });
        }

        async function fetchLeads() {
            updateStatus('loading', 'Fetching leads...');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Handle different response formats
                allLeads = Array.isArray(data) ? data : (data.leads || data.data || []);
                
                // Sort by Added Date (newest first) by default
                sortLeadsByDate();
                
                updateStatus('success', `Loaded ${allLeads.length} leads`);
                renderLeads();
                renderStats();
                
            } catch (error) {
                console.error('Error fetching leads:', error);
                updateStatus('error', 'Failed to load leads');
                renderError(error.message);
            }
        }

        async function fetchDashboardData() {
            try {
                const response = await fetch(DASHBOARD_API_URL, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Dashboard API error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Handle response format - should be an array with one object
                if (Array.isArray(data) && data.length > 0) {
                    dashboardData = data[0];
                } else {
                    dashboardData = data;
                }
                
                renderStats();
                
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                // Set default dashboard data if fetch fails
                dashboardData = {
                    "Total Patients Contacted": 0,
                    "Total Outstanding Debt In Collection": 0,
                    "Collected Debt": 0,
                    "Number of Debts Cleared": 0
                };
                renderStats();
            }
        }

        function updateStatus(type, message) {
            const statusDot = statusIndicator.querySelector('.status-dot');
            statusDot.className = `status-dot status-${type}`;
            statusText.textContent = message;
        }

        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredLeads = [...allLeads];
            } else {
                filteredLeads = allLeads.filter(lead => {
                    return Object.values(lead).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            sortLeads();
            renderLeads();
            renderStats();
        }

        function sortLeadsByDate() {
            const dateFields = ['Added Date', 'Date Added', 'Created Date', 'created', 'date', 'Date Created'];
            let dateField = null;
            
            // Find the correct date field in the data
            if (allLeads.length > 0) {
                const leadKeys = Object.keys(allLeads[0]);
                dateField = dateFields.find(field => leadKeys.includes(field));
            }
            
            if (dateField) {
                currentSort.column = dateField;
                currentSort.direction = 'desc'; // Newest first
                allLeads.sort((a, b) => {
                    const dateA = new Date(a[dateField]);
                    const dateB = new Date(b[dateField]);
                    
                    if (isNaN(dateA.getTime()) && isNaN(dateB.getTime())) return 0;
                    if (isNaN(dateA.getTime())) return 1;
                    if (isNaN(dateB.getTime())) return -1;
                    
                    return dateB - dateA; // Newest first (desc)
                });
            }
            
            filteredLeads = [...allLeads];
        }

        function sortLeads() {
            if (currentSort.column) {
                const isDateColumn = currentSort.column.toLowerCase().includes('date') || 
                                   currentSort.column.toLowerCase().includes('created');
                
                filteredLeads.sort((a, b) => {
                    let valueA = a[currentSort.column];
                    let valueB = b[currentSort.column];
                    
                    if (isDateColumn) {
                        valueA = new Date(valueA);
                        valueB = new Date(valueB);
                        
                        if (isNaN(valueA.getTime()) && isNaN(valueB.getTime())) return 0;
                        if (isNaN(valueA.getTime())) return 1;
                        if (isNaN(valueB.getTime())) return -1;
                    } else {
                        valueA = valueA ? valueA.toString().toLowerCase() : '';
                        valueB = valueB ? valueB.toString().toLowerCase() : '';
                    }
                    
                    if (valueA < valueB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valueA > valueB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
        }

        function handleSort(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            sortLeads();
            renderLeads();
        }

        function renderStats() {
            // Format currency values (assuming they're in dollars)
            const formatCurrency = (value) => {
                const num = parseFloat(value) || 0;
                return `$${num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };

            const formatNumber = (value) => {
                return parseInt(value) || 0;
            };

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${formatNumber(dashboardData['Total Patients In Collection'])}</div>
                    <div class="stat-label">Total Patients In Collection</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${formatCurrency(dashboardData['Total Outstanding Debt In Collection'])}</div>
                    <div class="stat-label">Total Outstanding Debt In Collection</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${formatCurrency(dashboardData['Collected Debt'])}</div>
                    <div class="stat-label">Collected Debt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${formatNumber(dashboardData['Number of Debts Cleared'])}</div>
                    <div class="stat-label">Number of Debts Cleared</div>
                </div>
            `;
        }

        function renderLeads() {
            if (filteredLeads.length === 0) {
                leadsContent.innerHTML = '';
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                
                const title = document.createElement('h3');
                const message = document.createElement('p');
                
                if (allLeads.length === 0) {
                    title.textContent = 'No leads available';
                    message.textContent = 'Click "Refresh Data" to load the latest leads from your webhook.';
                } else {
                    title.textContent = 'No leads match your search';
                    message.textContent = 'Try adjusting your search criteria or clear the search box.';
                }
                
                emptyState.appendChild(title);
                emptyState.appendChild(message);
                leadsContent.appendChild(emptyState);
                return;
            }

            // Get all unique keys from leads to create dynamic table headers
            const allKeys = [...new Set(filteredLeads.flatMap(lead => Object.keys(lead)))];
            const displayKeys = allKeys.filter(key => key !== 'id');

            // Create table structure
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            
            // Add pagination controls
            const paginationControls = document.createElement('div');
            paginationControls.className = 'pagination-controls';
            
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.textContent = '← Previous';
            prevBtn.onclick = () => scrollTableHorizontally(-300);
            
            const paginationInfo = document.createElement('span');
            paginationInfo.className = 'pagination-info';
            paginationInfo.textContent = 'Navigate columns using arrows';
            
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.textContent = 'Next →';
            nextBtn.onclick = () => scrollTableHorizontally(300);
            
            paginationControls.appendChild(prevBtn);
            paginationControls.appendChild(paginationInfo);
            paginationControls.appendChild(nextBtn);
            
            // Create table wrapper for smooth scrolling
            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'table-wrapper';
            tableWrapper.id = 'table-wrapper';
            
            // Add scroll event listener to update button states during manual scrolling
            tableWrapper.addEventListener('scroll', updatePaginationButtons);
            
            const table = document.createElement('table');
            table.className = 'leads-table';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            displayKeys.forEach(key => {
                const th = document.createElement('th');
                th.textContent = formatColumnHeader(key);
                
                // Make date columns sortable
                const isDateColumn = key.toLowerCase().includes('date') || 
                                   key.toLowerCase().includes('created');
                
                if (isDateColumn) {
                    th.style.cursor = 'pointer';
                    th.style.userSelect = 'none';
                    th.style.position = 'relative';
                    
                    // Add sort indicator
                    if (currentSort.column === key) {
                        const indicator = document.createElement('span');
                        indicator.style.marginLeft = '5px';
                        indicator.textContent = currentSort.direction === 'asc' ? '↑' : '↓';
                        th.appendChild(indicator);
                    }
                    
                    th.addEventListener('click', () => handleSort(key));
                    
                    // Add hover effect for sortable columns
                    th.addEventListener('mouseenter', () => {
                        th.style.backgroundColor = '#e9ecef';
                    });
                    
                    th.addEventListener('mouseleave', () => {
                        th.style.backgroundColor = '#f8f9fa';
                    });
                }
                
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            
            filteredLeads.forEach(lead => {
                const row = document.createElement('tr');
                
                displayKeys.forEach(key => {
                    const td = document.createElement('td');
                    const cellElement = createCellElement(key, lead[key], lead);
                    td.appendChild(cellElement);
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            tableWrapper.appendChild(table);
            
            tableContainer.appendChild(paginationControls);
            tableContainer.appendChild(tableWrapper);
            
            leadsContent.innerHTML = '';
            leadsContent.appendChild(tableContainer);
            
            // Update pagination button states after rendering
            setTimeout(updatePaginationButtons, 100);
        }

        function renderError(errorMessage) {
            leadsContent.innerHTML = '';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            
            const title = document.createElement('h3');
            title.textContent = 'Error Loading Leads';
            
            const messageP = document.createElement('p');
            messageP.textContent = errorMessage;
            
            const helpP = document.createElement('p');
            helpP.textContent = 'Please check your internet connection and try again.';
            
            errorDiv.appendChild(title);
            errorDiv.appendChild(messageP);
            errorDiv.appendChild(helpP);
            
            leadsContent.appendChild(errorDiv);
        }

        function scrollTableHorizontally(scrollAmount) {
            const tableWrapper = document.getElementById('table-wrapper');
            if (tableWrapper) {
                tableWrapper.scrollBy({
                    left: scrollAmount,
                    behavior: 'smooth'
                });
                
                // Wait for smooth scroll to complete before updating button states
                setTimeout(() => {
                    updatePaginationButtons();
                }, 300);
            }
        }

        function updatePaginationButtons() {
            const tableWrapper = document.getElementById('table-wrapper');
            const prevBtn = document.querySelector('.pagination-controls .pagination-btn:first-child');
            const nextBtn = document.querySelector('.pagination-controls .pagination-btn:last-child');
            
            if (tableWrapper && prevBtn && nextBtn) {
                const scrollLeft = tableWrapper.scrollLeft;
                const maxScroll = tableWrapper.scrollWidth - tableWrapper.clientWidth;
                
                // Disable previous button if at the beginning
                prevBtn.disabled = scrollLeft <= 0;
                
                // Disable next button if at the end
                nextBtn.disabled = scrollLeft >= maxScroll;
            }
        }

        function formatColumnHeader(key) {
            return key.replace(/([A-Z])/g, ' $1')
                     .replace(/^./, str => str.toUpperCase())
                     .replace(/_/g, ' ');
        }

        async function updateLeadStatus(phoneNumber, statusSpan, updateString = 'donotcall') {
            try {
                statusSpan.textContent = 'Updating...';
                statusSpan.style.background = '#ffc107';
                
                const response = await fetch('/api/update-lead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber,
                        update_string: updateString
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    if (updateString === 'donotcall') {
                        statusSpan.textContent = 'Do Not Call';
                        statusSpan.className = 'lead-status status-closed';
                    } else if (updateString === 'paid_at_office') {
                        statusSpan.textContent = 'Paid at Office';
                        statusSpan.className = 'lead-status status-qualified';
                    }
                } else {
                    statusSpan.textContent = 'Update Failed';
                    statusSpan.style.background = '#dc3545';
                    
                    setTimeout(() => {
                        statusSpan.textContent = statusSpan.getAttribute('data-original-status');
                        statusSpan.style.background = '';
                    }, 3000);
                }
                
            } catch (error) {
                console.error('Error updating lead:', error);
                statusSpan.textContent = 'Update Failed';
                statusSpan.style.background = '#dc3545';
                
                setTimeout(() => {
                    statusSpan.textContent = statusSpan.getAttribute('data-original-status');
                    statusSpan.style.background = '';
                }, 3000);
            }
        }

        function createCellElement(key, value, leadData = {}) {
            if (value === null || value === undefined) {
                const span = document.createElement('span');
                span.textContent = '-';
                return span;
            }

            // Format status with badge and dropdown for Final Status
            if (key.toLowerCase().includes('status')) {
                const status = value.toString().toLowerCase();
                const statusClass = getStatusClass(status);
                
                // Check if this is the Final Status column and get the lead's phone number
                if (key === 'Final Status') {
                    const container = document.createElement('div');
                    container.style.display = 'flex';
                    container.style.alignItems = 'center';
                    container.style.gap = '0.5rem';
                    container.style.height = '100%';
                    container.style.overflow = 'hidden';
                    
                    const span = document.createElement('span');
                    span.className = `lead-status ${statusClass}`;
                    span.textContent = value.toString();
                    
                    const dropdown = document.createElement('select');
                    dropdown.style.padding = '0.2rem 0.4rem';
                    dropdown.style.border = '1px solid #dee2e6';
                    dropdown.style.borderRadius = '4px';
                    dropdown.style.fontSize = '0.75rem';
                    dropdown.style.backgroundColor = 'white';
                    dropdown.style.cursor = 'pointer';
                    dropdown.style.height = '28px';
                    dropdown.style.minWidth = '120px';
                    
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Change Status';
                    dropdown.appendChild(defaultOption);
                    
                    const doNotCallOption = document.createElement('option');
                    doNotCallOption.value = 'donotcall';
                    doNotCallOption.textContent = 'Do Not Call';
                    dropdown.appendChild(doNotCallOption);
                    
                    const paidAtOfficeOption = document.createElement('option');
                    paidAtOfficeOption.value = 'paid_at_office';
                    paidAtOfficeOption.textContent = 'Paid at Office';
                    dropdown.appendChild(paidAtOfficeOption);
                    
                    // Get phone number from lead data
                    const phoneNumber = leadData['Phone Number'] || leadData['phone'] || leadData['Phone'] || '';
                    
                    // Store original status for fallback
                    span.setAttribute('data-original-status', value.toString());
                    
                    dropdown.addEventListener('change', function() {
                        if ((this.value === 'donotcall' || this.value === 'paid_at_office') && phoneNumber) {
                            updateLeadStatus(phoneNumber, span, this.value);
                            this.value = ''; // Reset dropdown
                        } else if ((this.value === 'donotcall' || this.value === 'paid_at_office') && !phoneNumber) {
                            alert('Phone number not found for this lead');
                            this.value = ''; // Reset dropdown
                        }
                    });
                    
                    container.appendChild(span);
                    container.appendChild(dropdown);
                    return container;
                } else {
                    const span = document.createElement('span');
                    span.className = `lead-status ${statusClass}`;
                    span.textContent = value.toString();
                    return span;
                }
            }

            // Format currency amounts (convert cents to dollars)
            if (key.toLowerCase().includes('amount') || key.toLowerCase().includes('debt') || key.toLowerCase().includes('balance')) {
                const num = parseFloat(value);
                if (!isNaN(num)) {
                    const span = document.createElement('span');
                    const dollars = num / 100; // Convert cents to dollars
                    span.textContent = `$${dollars.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    return span;
                }
            }

            // Format dates
            if (key.toLowerCase().includes('date') || key.toLowerCase().includes('created') || key.toLowerCase().includes('updated')) {
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    const span = document.createElement('span');
                    span.textContent = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    return span;
                }
            }

            // Format phone numbers
            if (key.toLowerCase().includes('phone')) {
                const phoneStr = value.toString().replace(/\D/g, '');
                if (phoneStr.length === 10) {
                    const span = document.createElement('span');
                    span.textContent = `(${phoneStr.slice(0,3)}) ${phoneStr.slice(3,6)}-${phoneStr.slice(6)}`;
                    return span;
                }
            }

            // Format boolean values
            if (typeof value === 'boolean' || (key.toLowerCase().includes('active') || key.toLowerCase().includes('contacted'))) {
                const span = document.createElement('span');
                span.className = value === true || value === 'true' ? 'lead-status status-qualified' : 'lead-status status-closed';
                span.textContent = value === true || value === 'true' ? 'Yes' : 'No';
                return span;
            }

            // Format payment links with send functionality
            if (key.toLowerCase().includes('link') && value.toString().startsWith('http')) {
                const sendButton = document.createElement('button');
                sendButton.style.background = '#667eea';
                sendButton.style.color = 'white';
                sendButton.style.border = 'none';
                sendButton.style.padding = '0.2rem 0.6rem';
                sendButton.style.borderRadius = '4px';
                sendButton.style.cursor = 'pointer';
                sendButton.style.fontSize = '0.75rem';
                sendButton.style.fontWeight = '600';
                sendButton.style.height = '28px';
                sendButton.style.whiteSpace = 'nowrap';
                sendButton.textContent = 'Text Link';
                
                sendButton.addEventListener('click', async () => {
                    try {
                        // Extract lead data
                        const firstName = leadData['First Name'] || leadData['first_name'] || leadData['Name'] || '';
                        const phoneNumber = leadData['Phone Number'] || leadData['phone'] || leadData['Phone'] || '';
                        
                        if (!phoneNumber) {
                            sendButton.textContent = 'No Phone';
                            sendButton.style.background = '#dc3545';
                            
                            setTimeout(() => {
                                sendButton.textContent = 'Text Link';
                                sendButton.style.background = '#667eea';
                            }, 2000);
                            return;
                        }
                        
                        sendButton.textContent = 'Sending...';
                        sendButton.style.background = '#ffc107';
                        
                        const response = await fetch('/api/send-pay-link', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                first_name: firstName,
                                phone_number: phoneNumber,
                                payment_link: value.toString()
                            })
                        });
                        
                        if (response.ok) {
                            sendButton.textContent = 'Sent!';
                            sendButton.style.background = '#28a745';
                        } else {
                            sendButton.textContent = 'Send Failed';
                            sendButton.style.background = '#dc3545';
                        }
                        
                        setTimeout(() => {
                            sendButton.textContent = 'Text Link';
                            sendButton.style.background = '#667eea';
                        }, 3000);
                        
                    } catch (err) {
                        console.error('Failed to send payment link: ', err);
                        sendButton.textContent = 'Send Failed';
                        sendButton.style.background = '#dc3545';
                        
                        setTimeout(() => {
                            sendButton.textContent = 'Text Link';
                            sendButton.style.background = '#667eea';
                        }, 3000);
                    }
                });
                
                return sendButton;
            }

            // Format email with mailto link
            if (key.toLowerCase().includes('email') && value.toString().includes('@')) {
                const emailValue = value.toString();
                // Basic email validation to prevent XSS
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (emailRegex.test(emailValue)) {
                    const link = document.createElement('a');
                    link.href = `mailto:${emailValue}`;
                    link.style.color = '#667eea';
                    link.style.textDecoration = 'none';
                    link.textContent = emailValue;
                    return link;
                }
            }

            // Default case - return text content safely
            const span = document.createElement('span');
            span.textContent = value.toString();
            return span;
        }

        function getStatusClass(status) {
            const statusLower = status.toLowerCase();
            if (statusLower.includes('payment') && statusLower.includes('confirmed')) {
                return 'status-qualified';
            }
            if (statusLower.includes('pending') || statusLower.includes('new')) {
                return 'status-new';
            }
            if (statusLower.includes('contacted') || statusLower.includes('progress')) {
                return 'status-contacted';
            }
            if (statusLower.includes('confirmed') || statusLower.includes('completed') || statusLower.includes('qualified')) {
                return 'status-qualified';
            }
            if (statusLower.includes('closed') || statusLower.includes('declined') || statusLower.includes('failed')) {
                return 'status-closed';
            }
            return 'status-new';
        }
    </script>
</body>
</html>